"use strict";var _createClass=function(){function n(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,a){return e&&n(t.prototype,e),a&&n(t,a),t}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var api=axios.create(),live_token="";api.interceptors.request.use(function(t){var e=live_token;return void 0!==e&&(t.headers.Authorization=e,t.headers["Content-Type"]="application/json;charset=UTF-8"),t},function(t){Promise.reject(t)}),api.interceptors.response.use(function(t){var e=t.headers.live_token;return void 0!==e&&(live_token=e),t},function(t){return Promise.reject(t)});var video=function(t){return new Base(t)},Base=function(){function e(t){_classCallCheck(this,e),this.element=document.getElementById(t),this.src=null,this.width="auto",this.height="auto",this.controls=!1,this.isLive=!0,this.volume=0,this.player=null,this.autostart=!1,this.image=null,this.hls={reconnecttime:5,num:null},this.AES_KEY=null,this.md5_key=null,this.res={src:"",TaskId:"",companyId:"",heartBeat:0}}return _createClass(e,[{key:"getUp",value:function(){var t,a=this,e=arguments[0];for(t in e)this[t]=e[t],this.image||(this.image="./img/q_ckplayer_w.png"),this.hls.num&&(this.num=this.hls.num);this.createVideo();var n=new Promise(function(t,e){a.createScript("https://www.six-armscloud.com/basicplatform/static/js/flv.js",function(){t(2)})}),r=new Promise(function(t,e){a.createScript("https://www.six-armscloud.com/basicplatform/static/js/md5.js",function(){t(2)})});Promise.all([n,r]).then(function(t){a.postLive()})}},{key:"createVideo",value:function(){var t=this,e=['<div id="videos" style="position: relative;margin:0 auto;width:'+this.width+"px;height:"+this.height+'px;"><video id="player"  muted  controls="'+this.controls+'"  autoplay="autoplay"  controlslist="nodownload"   width="'+this.width+'" height="'+this.height+'" style="object-fit: fill;background:#000"></video><div class="videoImg" style="width: 100%;position: absolute; top:0%;left:0%;height:100%;background:#000;display:'+(""!=this.image?"block":"none")+'"><div class="Img" style="width:500px;position:absolute;top:49%;left:50%;transform:translate(-50%, -50%);text-align:center;"><img src="'+this.image+'" alt=""></div></div> <div style="margin:0 auto;margin-top:5px;"><button id="start" style="margin-right:20px;">开始</button><button id="pause">暂停</button></div></div>'].join("");this.element.innerHTML=e,document.getElementById("pause").onclick=function(){t.pause()},document.getElementById("start").onclick=function(){t.start()}}},{key:"createScript",value:function(t,e){var a=document.createElement("script"),n=e||function(){};a.type="text/javascript",a.readyState?a.onreadystatechange=function(){"loaded"!=a.readyState&&"complete"!=a.readyState||(a.onreadystatechange=null,n())}:a.onload=function(){n()},a.src=t,document.getElementsByTagName("head")[0].appendChild(a)}},{key:"create",value:function(){var e=this,t=document.querySelector("#player");t&&(t.disablePictureInPicture=!0);var a={type:"flv",isLive:this.isLive,hasAudio:!1,hasVideo:!0,url:this.src};this.player=flvjs.createPlayer(a,{enableWorker:!0,enableStashBuffer:!1,stashInitialSize:128,lazyLoad:!1,lazyLoadMaxDuration:180,lazyLoadRecoverDuration:30,deferLoadAfterSourceOpen:!1,autoCleanupSourceBuffer:!0,autoCleanupMaxBackwardDuration:180,autoCleanupMinBackwardDuration:120,statisticsInfoReportInterval:600,fixAudioTimestampGap:!1}),this.player.attachMediaElement(t),this.player.load(),this.player.play(),this.heartBeat(),document.querySelector(".videoImg").style.display="none",this.player.on("error",function(t){"MediaError"==t?e.destroy():0==e.hls.num?e.player.destroy():(clearTimeout(null),setTimeout(function(){e.create(),null!=e.hls.num&&0<e.hls.num&&e.hls.num--},1e3*e.hls.reconnecttime))})}},{key:"start",value:function(){this.player&&this.player.play()}},{key:"pause",value:function(){console.log("222"),this.player&&this.player.pause()}},{key:"destroy",value:function(){if(this.player){try{this.player.pause(),this.player.unload(),this.player.detachMediaElement(),this.player.destroy()}catch(t){console.log("video-destroy-error:"+t)}this.player=null,document.querySelector(".videoImg").style.display="block"}}},{key:"postLive",value:function(t){var e=this,a={},n=[];a.timestamp=(new Date).getTime(),a.customerNo="publicModule",a.charset="utf-8",a.method="getLiveData",a.versionNo="1.0.0.0",a.signType="MD5",a.p=m.http.url("p");var r,i=objKeySort(a);for(r in i)""!==i[r]&&n.push(r+"="+i[r]);a.sign=hex_md5(n.join("&")+"6a42917dac1348ff818ee1856bddf10a"),m.http.post("PostLiveData",a,{"Content-Type":"application/json;charset=UTF-8"}).then(function(t){t=t.data;0==t.resCode&&(e.res.TaskId=t.data.videoVo.taskId,e.res.companyId=t.data.videoVo.cmrGuid,e.res.heartBeat=t.data.videoVo.heartbeat,e.src=t.data.videoVo.flvUrl,e.create())})}},{key:"heartBeat",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.res.TaskId,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.res.companyId,a=this,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this.res.heartBeat,r=arguments[3];this.clearHeartBeat(),window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(function(){""!==t&&null!=t&&m.http.posts("postPlayHeartbeat",{taskId:t,companyId:e}).then(function(t){0==t.data.resCode?r&&r(t):(a.destroy(),a.clearHeartBeat(),window.clearInterval(a.heartBeatTimer),alert("服务异常,停止播放"))}).catch(function(){a.clearHeartBeat(),window.clearInterval(a.heartBeatTimer),a.destroy()})},1e3*(n||10))}},{key:"clearHeartBeat",value:function(){this.heartBeatTimer&&(window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=null)}}]),e}(),objKeySort=function(t){for(var e=Object.keys(t).sort(),a={},n=0;n<e.length;n++)a[e[n]]=t[e[n]];return a},namespace=function(){for(var t=arguments,e=0;e<t.length;e++)for(var a=t[e].split("."),n=window,r=0;r<a.length;r++)n[a[r]]=n[a[r]]||{},n=n[a[r]];return n},getParamType=function(t){return null==t?String(t):Object.prototype.toString.call(t).replace(/\[object\s+(\w+)\]/i,"$1")||"object"};namespace("m.http"),m.extend=function(t,e){if(null==t)t=e;else for(var a in e)"object"===getParamType(e[a]).toLowerCase()&&"object"===getParamType(t[a]).toLowerCase()?extend(t[a],e[a]):t[a]=e[a];return t},m.extend(m.http,{get:function(t){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return new Promise(function(e,a){api({url:m.host.geturl(t),method:"get",data:n}).then(function(t){e(t)}).catch(function(t){a(t)})})},post:function(t){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};return new Promise(function(e,a){api({url:m.host.geturl(t),method:"post",data:n,headers:r}).then(function(t){e(t)}).catch(function(t){a(t)})})},posts:function(t){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};return new Promise(function(e,a){api({url:m.host.geturl(t)+"?taskId="+n.taskId,method:"post",data:n,headers:r}).then(function(t){e(t)}).catch(function(t){a(t)})})},url:function(t){for(var e,a=(e=window.location.href.replace(/#+.*$/,"")).substring(e.indexOf("?")+1,e.length).split("&"),n={},r=0;r<a.length;r++){var i=a[r].indexOf("="),o=a[r].substring(0,i),i=a[r].substring(i+1);n[o]=i}return void 0===n[t]?"":n[t]}}),namespace("m.AES"),m.extend(m.AES,{encrypt:function(t,e){e=e||"abcdefgabcdefg12";e=CryptoJS.enc.Utf8.parse(e),t=CryptoJS.enc.Utf8.parse(t);return CryptoJS.AES.encrypt(t,e,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7}).toString()},decrypt:function(t,e){e=e||"abcdefgabcdefg12";var e=CryptoJS.enc.Utf8.parse(e),a=CryptoJS.AES.decrypt(t,e,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7});return CryptoJS.enc.Utf8.stringify(a).toString()}}),namespace("m.host"),m.extend(m.host,{proUrl:{baseURL:"http://139.9.121.98:8779"},Httpurl:{postPlayHeartbeat:"/api/outService/playHeartbeat",PostLiveData:"/noAuth/getLiveData",postClosePlayTask:"/api/smartCash/v1.0/closePlayTask",getPlayRealTime:"/api/smartCash/v1.0/playRealTime"},geturl:function(t){return proUrl.baseURL+Httpurl[t]}}),m.extend(window,m.http),m.extend(window,m.AES),m.extend(window,m.host);